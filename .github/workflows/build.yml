name: Build artifacts

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}
  release:
    types: [created]
  workflow_call: {}

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 and install toolchains
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: |
            mingw-w64-x86_64-toolchain
            mingw-w64-i686-toolchain

      - name: Add mingw bins to PATH for subsequent steps
        shell: pwsh
        run: |
          Write-Host "Adding C:\\mingw64\\bin and C:\\mingw32\\bin to PATH for remaining steps"
          if (Test-Path 'C:\mingw64\bin') { "C:\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append }
          if (Test-Path 'C:\mingw32\bin') { "C:\mingw32\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append }

      - name: Show compilers (debug)
        shell: pwsh
        run: |
          Get-Command x86_64-w64-mingw32-g++ -ErrorAction SilentlyContinue | ForEach-Object { "x86_64: $($_.Source)" }
          Get-Command i686-w64-mingw32-g++ -ErrorAction SilentlyContinue | ForEach-Object { "i686: $($_.Source)" }
          Write-Host "Check potential mingw32/mingw64 folders:"
          if (Test-Path C:\mingw64\bin) { Get-ChildItem C:\mingw64\bin\*g++* | Select-Object FullName, Length -First 5 }
          if (Test-Path C:\mingw32\bin) { Get-ChildItem C:\mingw32\bin\*g++* | Select-Object FullName, Length -First 5 }
          & x86_64-w64-mingw32-g++ --version 2>&1 | Select-Object -First 1 || Write-Host 'x86_64 compiler not found'
          & i686-w64-mingw32-g++ --version 2>&1 | Select-Object -First 1 || Write-Host 'i686 compiler not found'

      - name: Build x86_64 binary (explicit cross-compiler)
        shell: pwsh
        run: |
          $compiler = 'x86_64-w64-mingw32-g++'
          & $compiler '-Os' '-s' '-flto' '-fno-exceptions' '-fno-rtti' '-ffunction-sections' '-fdata-sections' '-Wl,--gc-sections' '-Wl,--strip-all' '-static-libgcc' '-static-libstdc++' '-Wl,-Bstatic' '-lwinpthread' '-Wl,-Bdynamic' '-o' 'reboot-x64.exe' 'reboot.cpp' '-ladvapi32'

      - name: Build i686 binary (explicit cross-compiler)
        shell: pwsh
        run: |
          $i686path = 'C:\mingw32\bin\i686-w64-mingw32-g++.exe'
          if (Test-Path $i686path) {
            Write-Host "Using $i686path"
            & $i686path '-Os' '-s' '-flto' '-fno-exceptions' '-fno-rtti' '-ffunction-sections' '-fdata-sections' '-Wl,--gc-sections' '-Wl,--strip-all' '-static-libgcc' '-static-libstdc++' '-Wl,-Bstatic' '-lwinpthread' '-Wl,-Bdynamic' '-o' 'reboot-x86.exe' 'reboot.cpp' '-ladvapi32'
          } else {
            Write-Host "Falling back to i686-w64-mingw32-g++ on PATH"
            $compiler = 'i686-w64-mingw32-g++'
            & $compiler '-Os' '-s' '-flto' '-fno-exceptions' '-fno-rtti' '-ffunction-sections' '-fdata-sections' '-Wl,--gc-sections' '-Wl,--strip-all' '-static-libgcc' '-static-libstdc++' '-Wl,-Bstatic' '-lwinpthread' '-Wl,-Bdynamic' '-o' 'reboot-x86.exe' 'reboot.cpp' '-ladvapi32'
          }

      - name: Strip binaries if strip available
        shell: pwsh
        run: |
          try { & 'x86_64-w64-mingw32-strip' 'reboot-x64.exe' } catch { }
          try { & 'i686-w64-mingw32-strip' 'reboot-x86.exe' } catch { }

      - name: Verify architectures and sizes
        shell: pwsh
        run: |
          try { & 'objdump' '-f' 'reboot-x64.exe' } catch { Write-Host 'objdump not found or failed for reboot-x64.exe' }
          Get-Item reboot-x64.exe | Select-Object Name, @{Name='KB';Expression={[math]::Round($_.Length/1024,2)}}
          try { & 'objdump' '-f' 'reboot-x86.exe' } catch { Write-Host 'objdump not found or failed for reboot-x86.exe' }
          Get-Item reboot-x86.exe | Select-Object Name, @{Name='KB';Expression={[math]::Round($_.Length/1024,2)}}

      - name: Prepare Windows artifact directory
        shell: powershell
        run: |
          $out = "artifact-windows"
          if (Test-Path $out) { Remove-Item -Recurse -Force $out }
          New-Item -ItemType Directory -Path $out
          Copy-Item -Path reboot-x64.exe, reboot-x86.exe, install.bat -Destination $out

      - name: Upload Windows artifact directory
        uses: actions/upload-artifact@v4
        with:
          name: reboot-windows
          path: artifact-windows

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build Linux binary
        run: g++ -O2 -o reboot reboot.cpp

      - name: Prepare Linux artifact directory
        run: |
          rm -rf artifact-linux
          mkdir -p artifact-linux
          cp reboot artifact-linux/

      - name: Upload Linux artifact directory
        uses: actions/upload-artifact@v4
        with:
          name: reboot-linux
          path: artifact-linux

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS binary
        run: clang++ -O2 -o reboot reboot.cpp -framework CoreFoundation -framework ApplicationServices

      - name: Prepare macOS artifact directory
        run: |
          rm -rf artifact-macos
          mkdir -p artifact-macos
          cp reboot artifact-macos/

      - name: Upload macOS artifact directory
        uses: actions/upload-artifact@v4
        with:
          name: reboot-macos
          path: artifact-macos
